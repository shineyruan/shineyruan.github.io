<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>My F1TENTH Journey — Lab 4, Reactive Planning Methods for Obstacle Avoidance - Ryan's Blog</title><meta name=Description content="F1Tenth Course Lab 4"><meta property="og:title" content="My F1TENTH Journey — Lab 4, Reactive Planning Methods for Obstacle Avoidance"><meta property="og:description" content="F1Tenth Course Lab 4"><meta property="og:type" content="article"><meta property="og:url" content="https://zhihaoruan.xyz/f1tenth-lab4/"><meta property="og:image" content="https://zhihaoruan.xyz/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-27T23:48:30-04:00"><meta property="article:modified_time" content="2023-03-30T01:18:30-07:00"><meta property="og:site_name" content="Ryan's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://zhihaoruan.xyz/logo.png"><meta name=twitter:title content="My F1TENTH Journey — Lab 4, Reactive Planning Methods for Obstacle Avoidance"><meta name=twitter:description content="F1Tenth Course Lab 4"><meta name=application-name content="Ryan's Blog"><meta name=apple-mobile-web-app-title content="Ryan's Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://zhihaoruan.xyz/f1tenth-lab4/><link rel=prev href=https://zhihaoruan.xyz/f1tenth-lab3/><link rel=next href=https://zhihaoruan.xyz/f1tenth-lab6/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"My F1TENTH Journey — Lab 4, Reactive Planning Methods for Obstacle Avoidance","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/zhihaoruan.xyz\/f1tenth-lab4\/"},"genre":"posts","keywords":"F1Tenth, F1Tenth Racing, Multi-lingual","wordcount":718,"url":"https:\/\/zhihaoruan.xyz\/f1tenth-lab4\/","datePublished":"2021-01-27T23:48:30-04:00","dateModified":"2023-03-30T01:18:30-07:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Zhihao Ruan"},"description":"F1Tenth Course Lab 4"}</script></head><body data-header-desktop=auto data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Ryan's Blog">Ryan's Blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/categories/projects/>Projects </a><a class=menu-item href=/categories/my-gallery/>My Gallery </a><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="menu-item language" title="Select Language"><i class="fa fa-globe" aria-hidden=true></i>
<select class=language-select id=language-select-desktop onchange="location=this.value"><option value=/f1tenth-lab4/ selected>English</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Ryan's Blog">Ryan's Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/categories/projects/ title>Projects</a><a class=menu-item href=/categories/my-gallery/ title>My Gallery</a><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class=menu-item title="Select Language"><i class="fa fa-globe fa-fw" aria-hidden=true></i>
<select class=language-select onchange="location=this.value"><option value=/f1tenth-lab4/ selected>English</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">My F1TENTH Journey — Lab 4, Reactive Planning Methods for Obstacle Avoidance</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Zhihao Ruan</a></span>&nbsp;<span class=post-category>included in <a href=/categories/projects/><i class="far fa-folder fa-fw" aria-hidden=true></i>Projects</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2021-01-27>2021-01-27</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;718 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;4 minutes&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/images/posts/f1tenth-lab4/f1tenth-lab4.png data-srcset="/images/posts/f1tenth-lab4/f1tenth-lab4.png, /images/posts/f1tenth-lab4/f1tenth-lab4.png 1.5x, /images/posts/f1tenth-lab4/f1tenth-lab4.png 2x" data-sizes=auto alt=/images/posts/f1tenth-lab4/f1tenth-lab4.png title="F1Tenth Course Lab 4" width=3840 height=2160></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#overview>Overview</a><ul><li><a href=#follow-the-gap-algorithm>&ldquo;Follow the Gap&rdquo; Algorithm</a></li><li><a href=#notes-in-real-practice>Notes in Real Practice</a></li></ul></li><li><a href=#demo-videos>Demo Videos</a></li><li><a href=#references>References</a></li></ul></nav></div></div><div class=content id=content><p><em><strong>This series of blogs marks the journey of my F1/10 Autonomous Racing Cars.</strong></em></p><p><em><strong>All my source codes can be accessed <a href=https://github.com/shineyruan/F1Tenth_Labs target=_blank rel="noopener noreffer">here</a>.</strong></em></p><p><strong>Previous post:</strong></p><ul><li><a href=https://zhihaoruan.xyz/f1tenth-lab1/ rel>My F1TENTH Journey — Lab 1, Introduction to ROS</a></li><li><a href=https://zhihaoruan.xyz/f1tenth-lab2/ rel>My F1TENTH Journey — Lab 2, Automatic Emergency Braking</a></li><li><a href=https://zhihaoruan.xyz/f1tenth-lab3/ rel>My F1TENTH Journey — Lab 3, PID-Controlled Wall Follower</a></li></ul><h2 id=overview>Overview</h2><p>Obstacle avoidance is one of the critical parts of autonomous driving. Crashing into obstacles could possibly bring serious damages to both the car and the object that it runs into. Overtime, researchers and developers have come up with multiple ways to avoid obstacles. This lab focuses on implementing a reactive way (also passive way) of avoiding obstacles to drive the car around in free space, provided with only real-time 2D LiDAR sensor data.</p><h3 id=follow-the-gap-algorithm>&ldquo;Follow the Gap&rdquo; Algorithm</h3><p>With 2D laser scan data, we can easily tell whether there is an obstacle in front of us by looking into the range (length) of each beam. If the range of a certain beam is small, we know that the laser travelling in this direction hits an obstacle in close range; conversely, if the range of a beam is large, we know that the laser beam is able to travel very far before hitting on an obstacle, and thus we can consider this direction as &ldquo;free space&rdquo;. &ldquo;Follow the Gap&rdquo; algorithm states that, for each incoming <code>LaserScan</code> LiDAR data, we first figure out the direction of the closest obstacle, and then try to maneuver the vehicle in the direction of &ldquo;free space&rdquo; to avoid this obstacle.</p><p>In theory, &ldquo;Follow the Gap&rdquo; planner can be done in the several steps:</p><ol><li>Find the nearest LiDAR endpoint and put a &ldquo;safety bubble&rdquo; of radius $r$ around it.</li><li>Set all endpoints inside the bubble to distance $0$. All non-zero endpoints are considered &ldquo;free space&rdquo;.</li><li>Find maximum length sequence of consecutive non-zero endpoints and identify the &ldquo;widest&rdquo; free space. (The <strong>max-gap.</strong>)</li><li>Choose the furthest endpoint in the max-gap, and steer the vehicle in that direction with some certain speed.</li></ol><figure><img src=f1tenth-lab4.png alt="&amp;lsquo;Follow the Gap&amp;rsquo; Algorithms in diagrams."><figcaption><p>&lsquo;Follow the Gap&rsquo; Algorithms in diagrams.</p></figcaption></figure><h3 id=notes-in-real-practice>Notes in Real Practice</h3><ol><li><strong>Laser scan data must be smoothed and de-noised.</strong></li></ol><p>In actual implementation, we can never obtain a clean laser scan data from LiDAR sensor. Due to hardware issues the raw data would contain lots of noises and glitches. To smooth the data, I applied a <strong>sliding window of size 5</strong> to average out each of the endpoints. I also <strong>clip the data within <code>[range_min, range_max)</code></strong> according to the parameters in the incoming <code>LaserScan</code> ROS message.</p><ol start=2><li><strong>Calculate the distance between two laser scan endpoints with trigonometric formulas.</strong></li></ol><p>In the algorithm we wish to draw a &ldquo;safety bubble&rdquo; around the nearest endpoint by traversing all laser beams and setting all endpoints within the radius of that bubble to $0$. But with laser scan data, how can we compute the distance between two endpoints? Trigonometry provides us with a power tool called <a href=https://en.wikipedia.org/wiki/Law_of_cosines target=_blank rel="noopener noreffer"><strong>the Law of Cosines.</strong></a> With laser beams of range $r_1,r_2$ and their angle $\theta$, we can draw a triangle among the vehicle, endpoint 1, endpoint 2, and apply:
$$d=\sqrt{r_1^2+r_2^2-2r_1r_2\cos\theta},$$
which gives us the distance between the two endpoints.</p><ol start=3><li><strong>Impose a &ldquo;safety angle&rdquo; around the safety bubbles.</strong></li></ol><p>One of the corner case in testing the algorithm is the corner of the wall. As the figure indicates below, the car detects the corner of the wall and has marked it as an obstacle, setting all points within the safety bubble as 0. However, <em>the laser beam direction that detects the farthest endpoint in the max-gap happens to be right next to the obstacle,</em> causing the car to make a left turn rather than right turn, and directly hits the wall.</p><figure><img src=f1tenth-lab4-safety-angle.png alt="Demonstration of a corner case without safety angle." width=400><figcaption><p>Demonstration of a corner case without safety angle.</p></figcaption></figure><p>To address this issue, I added a &ldquo;safety angle&rdquo; around the bubble, which basically sets the laser beams too close to the direction of obstacles to distance 0. For instance, a safety angle of 20 degrees would set additional laser beams in the direction leftwards of the bubble by 20 degrees and rightwards of that bubble by 20 degrees also to 0. This simple method would prevent the vehicle to get too close to the obstacle, even if the best direction of free space happens to be next to the obstacle.</p><h2 id=demo-videos>Demo Videos</h2><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube-nocookie.com/embed/tDPHbiQ0Ds8 style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div><h2 id=references>References</h2><p>F1/10 Autonomous Racing Lecture: Reactive Methods for Planning<div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube-nocookie.com/embed/7VLYP-z9hTw style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-03-30&nbsp;<a class=git-hash href=https://github.com/shineyruan/shineyruan.github.io/commit/d512269a88b05c47da3764a8128cc1dafa864d38 target=_blank title="commit by Zhihao Ruan(shineyruan@gmail.com) d512269a88b05c47da3764a8128cc1dafa864d38: multilingual support">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>d512269</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/f1tenth-lab4/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://zhihaoruan.xyz/f1tenth-lab4/ data-title="My F1TENTH Journey — Lab 4, Reactive Planning Methods for Obstacle Avoidance" data-hashtags="F1Tenth,F1Tenth Racing,Multi-lingual"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://zhihaoruan.xyz/f1tenth-lab4/ data-hashtag=F1Tenth><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://zhihaoruan.xyz/f1tenth-lab4/ data-title="My F1TENTH Journey — Lab 4, Reactive Planning Methods for Obstacle Avoidance"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://zhihaoruan.xyz/f1tenth-lab4/ data-title="My F1TENTH Journey — Lab 4, Reactive Planning Methods for Obstacle Avoidance"><i data-svg-src=/lib/simple-icons/icons/line.min.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://zhihaoruan.xyz/f1tenth-lab4/ data-title="My F1TENTH Journey — Lab 4, Reactive Planning Methods for Obstacle Avoidance" data-image=/images/posts/f1tenth-lab4/f1tenth-lab4.png><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/f1tenth/>f1tenth</a>,&nbsp;<a href=/tags/f1tenth-racing/>F1Tenth Racing</a>,&nbsp;<a href=/tags/multi-lingual/>Multi-lingual</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/f1tenth-lab3/ class=prev rel=prev title="My F1TENTH Journey — Lab 3, PID-Controlled Wall Follower"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>My F1TENTH Journey — Lab 3, PID-Controlled Wall Follower</a>
<a href=/f1tenth-lab6/ class=next rel=next title="My F1TENTH Journey — Lab 6, Pure Pursuit (Waypoint Tracker)">My F1TENTH Journey — Lab 6, Pure Pursuit (Waypoint Tracker)<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.115.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Zhihao Ruan</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>