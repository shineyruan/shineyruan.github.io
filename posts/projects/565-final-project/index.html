<!doctype html><html><head><title>Volume Rendered ReSTIR in Vulkan</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link rel=stylesheet href=/css/flag-icon.min.css><link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css><link rel=icon type=image/png href=/images/site/favicon-32x32-ZR_hu8be55ec36a526970238b8207e0c8eab8_2764_42x0_resize_box_2.png><meta property="og:title" content="Volume Rendered ReSTIR in Vulkan"><meta property="og:description" content="This is a project of a Vulkan implementation of Fast Volume Rendering with Spatiotemporal Reservoir Resampling. It achieves the following:
 Vulkan ray tracing pipeline with nvpro and Vulkan Ray Tracing KHR extension. Volume assets loading and rendering through OpenVDB. ReSTIR algorithm rendering on GLTF scene and volume assets.  Authors  Zhihao Ruan (ruanzh@seas.upenn.edu), Shubham Sharma (sshubh@seas.upenn.edu), Raymond Yang (rayyang@seas.upenn.edu) Tested on: Windows 10 Home 21H1 Build 19043.1288, Ryzen 7 3700X @ 3."><meta property="og:type" content="article"><meta property="og:url" content="https://zhihaoruan.xyz/posts/projects/565-final-project/"><meta property="article:published_time" content="2021-12-27T02:41:46+00:00"><meta property="article:modified_time" content="2021-12-27T02:41:46+00:00"><meta name=description content="Volume Rendered ReSTIR in Vulkan"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><link rel=stylesheet href=/css/style.css></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/>Ryan's Blog</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><a href=/posts/introduction/ title=Introduction>Introduction</a></li><li><i class="fas fa-plus-circle"></i><a href=/posts/lecturenotes/>Lecture Notes</a><ul><li><a href=/posts/lecturenotes/ve320-notes/ title="VE320 Course Final Summary">VE320 Course Final Summary</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/gallery/>My Personal Gallery</a><ul><li><a href=/posts/gallery/ann-arbor/ title="Ann Arbor">Ann Arbor</a></li><li><a href=/posts/gallery/blue-hour/ title="Blue Hour">Blue Hour</a></li><li><a href=/posts/gallery/covid-19/ title="Capturing COVID-19">Capturing COVID-19</a></li><li><a href=/posts/gallery/hong-kong/ title="Hong Kong">Hong Kong</a></li><li><a href=/posts/gallery/dublin/ title=Ireland>Ireland</a></li><li><a href=/posts/gallery/london/ title=London>London</a></li><li><a href=/posts/gallery/michigan/ title=Michigan>Michigan</a></li><li><a href=/posts/gallery/zhuhai/ title=Zhuhai>Zhuhai</a></li></ul></li><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/projects/>Projects</a><ul class=active><li><a href=/posts/projects/565-cuda-path-tracer/ title="CUDA Path Tracer">CUDA Path Tracer</a></li><li><a href=/posts/projects/373proj/ title="EECS 373 Project">EECS 373 Project</a></li><li><a href=/posts/projects/560proj/ title="Mini Minecraft">Mini Minecraft</a></li><li><a href=/posts/projects/450proj/ title="SJTU Undergraduate Design Expo">SJTU Undergraduate Design Expo</a></li><li><a href=/posts/projects/467proj-slam/ title="SLAM Project">SLAM Project</a></li><li><a class=active href=/posts/projects/565-final-project/ title="Volume Rendered ReSTIR">Volume Rendered ReSTIR</a></li><li><a href=/posts/projects/565-vulkan-grass-rendering/ title="Vulkan Grass Rendering">Vulkan Grass Rendering</a></li><li><i class="fas fa-plus-circle"></i><a href=/posts/projects/f1tenth-labs/>F1Tenth Course Labs</a><ul><li><a href=/posts/projects/f1tenth-labs/f1tenth-lab1/ title="F1Tenth Course Lab 1">F1Tenth Course Lab 1</a></li><li><a href=/posts/projects/f1tenth-labs/f1tenth-lab2/ title="F1Tenth Course Lab 2">F1Tenth Course Lab 2</a></li><li><a href=/posts/projects/f1tenth-labs/f1tenth-lab3/ title="F1Tenth Course Lab 3">F1Tenth Course Lab 3</a></li><li><a href=/posts/projects/f1tenth-labs/f1tenth-lab4/ title="F1Tenth Course Lab 4">F1Tenth Course Lab 4</a></li><li><a href=/posts/projects/f1tenth-labs/f1tenth-lab6/ title="F1Tenth Course Lab 6">F1Tenth Course Lab 6</a></li></ul></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/journals/>Travel Journals</a><ul><li><a href=/posts/journals/phuket-journal/ title="Phuket Journal">Phuket Journal</a></li><li><a href=/posts/journals/puerto-rico-journal/ title="Puerto Rico's Journal">Puerto Rico's Journal</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://zhihaoruan.xyz/images/posts/565-final-project/bunny.png)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/avatar_hufa2498ddc73a49f179638934ba5c8634_1773717_120x120_fit_q75_box.jpg alt="Author Image"><h5 class=author-name>Zhihao (Ryan) Ruan</h5><p>December 27, 2021</p></div><div class=title><h1>Volume Rendered ReSTIR in Vulkan</h1></div><div class=post-content id=post-content><p>This is a project of a Vulkan implementation of Fast Volume Rendering with Spatiotemporal Reservoir Resampling. It achieves the following:</p><ul><li>Vulkan ray tracing pipeline with <a href=https://github.com/nvpro-samples/nvpro_core>nvpro</a> and Vulkan Ray Tracing KHR extension.</li><li>Volume assets loading and rendering through <a href=https://www.openvdb.org/>OpenVDB</a>.</li><li>ReSTIR algorithm rendering on GLTF scene and volume assets.</li></ul><h3 id=authors>Authors</h3><ul><li>Zhihao Ruan (<a href=mailto:ruanzh@seas.upenn.edu>ruanzh@seas.upenn.edu</a>), Shubham Sharma (<a href=mailto:sshubh@seas.upenn.edu>sshubh@seas.upenn.edu</a>), Raymond Yang (<a href=mailto:rayyang@seas.upenn.edu>rayyang@seas.upenn.edu</a>)</li><li>Tested on: Windows 10 Home 21H1 Build 19043.1288, Ryzen 7 3700X @ 3.59GHz 48GB, RTX 2060 Super 8GB</li></ul><p><strong>This project requires an RTX-compatible (Vulkan Ray Tracing KHR-compatible) graphics card to run.</strong></p><p><img src=explosion2.gif alt></p><h3 id=demos>Demos</h3><table><thead><tr><th style=text-align:center>Volume-ReSTIR</th><th style=text-align:center>Normal ReSTIR</th></tr></thead><tbody><tr><td style=text-align:center><img src=demo1.png alt></td><td style=text-align:center><img src=demo3.png alt></td></tr></tbody></table><table><thead><tr><th style=text-align:center>Ray Traced Volume Rendering (with OBJ Models)</th><th style=text-align:center>Ray Traced Volume Rendering</th></tr></thead><tbody><tr><td style=text-align:center><img src=demo2.png alt></td><td style=text-align:center><img src=demo4.png alt></td></tr></tbody></table><h4 id=rasterization-vs-path-tracing>Rasterization vs. Path Tracing</h4><table><thead><tr><th style=text-align:center>Rasterization</th><th style=text-align:center>Path Tracing</th></tr></thead><tbody><tr><td style=text-align:center><img src=rasterizer.png alt></td><td style=text-align:center><img src=path_tracer.gif alt></td></tr></tbody></table><h4 id=restir>ReSTIR</h4><p><img src=fire.gif alt></p><h3 id=introduction>Introduction</h3><p>ReSTIR has been a very successful fast path tracing-based rendering algorithm in recent computer graphics. However, the current state-of-the-art ReSTIR algorithm only works with meshes. Moreover, there exists some common objects in the scene that are not suitable for mesh creation. VDB asset is a special kind of asset that compensates the drawback of meshes and provides a much more accurate description for volume-based objects, such as smokes, clouds, fire flames, etc. Therefore, it is of great importance to migrate current ReSTIR procedures on volume assets so that we could also render the smokes and clouds photo-realistically and efficiently.</p><h4 id=vdb-data-structures>VDB Data Structures</h4><p>VDB is a special type of data structure for smokes, clouds, fire flames, etc. that is based on hierarchical voxel grids. It essentially holds a set of particles. It also uses a similar tree-like data structure as scene graphs for fast traversal and access that stores all transformations at intermediate nodes, and only the particle positions at leaf nodes.</p><figure><img src=vdb-pot.png alt="A VDB asset of a pot."><figcaption><p>A VDB asset of a pot.</p></figcaption></figure><figure><img src=VDB.png alt="A VDB illustration of a smoke asset."><figcaption><p>A VDB illustration of a smoke asset.</p></figcaption></figure><figure><img src=VDB-diagram.jpeg alt="A diagram for VDB data structure."><figcaption><p>A diagram for VDB data structure.</p></figcaption></figure><h4 id=restir-algorithm>ReSTIR Algorithm</h4><p><em>Source:</em></p><ul><li><a href=https://research.nvidia.com/sites/default/files/pubs/2020-07_Spatiotemporal-reservoir-resampling/ReSTIR.pdf><em>Spatiotemporal reservoir resampling for real-time ray tracing with dynamic direct lighting</em></a></li><li><a href=https://research.nvidia.com/publication/2021-11_Fast-Volume-Rendering><em>Fast Volume Rendering with Spatiotemporal Reservoir Resampling</em></a></li></ul><p>ReSTIR algorithm is a special ray tracing-based rendering algorithm that deals with large number of light source efficiently. It takes advantage of alias tables for Resampled Importance Sampling (RIS) and flexible reservoir data structures. RIS effectively culls images of low weight lights and constructs a PDF (Probability Distribution Function) of lights for the scene. The reservoirs, allocated one for each pixel, map geometry collisions to light sources in the scene. The reservoirs are easily updated for every bounce, each time considering a candidate from a subset of all lights. If the candidate is chosen, the reservoir will map the geometry to the new light. As more samples are considered, it becomes less likely for any candidate to be placed into the reservoir. These reservoirs use a combination of probability and giving up precision to generate result pixel color such that the image converges in near real time.</p><p><img src=ReSTIR.png alt></p><h4 id=vulkan-ray-tracing>Vulkan Ray Tracing</h4><p>Vulkan is considered as the next-generation API for uniform graphics drivers. It is fast, efficient, light weight, but yet verbose. Vulkan users needs to explicitly set up every little details of the entire rendering pipeline, which is often quite problematic. In this project we provide an explicit example of setting up a working Vulkan rendering pipeline, and it generally involves the following procedures:</p><ol><li>Set up <a href=https://github.com/glfw/glfw>glfw</a> to work with the latest version of Vulkan.</li><li>Initialize Vulkan instance, Vulkan physical device, Vulkan logical device, Vulkan swapchain (for passing to frame buffer display), Vulkan graphics command queue.</li><li>Create all buffers to be passed to device memory. This includes: frame buffer, rendering pipeline description buffer, data buffer (primitive vertices, indices, normals, materials, textures, etc.).</li><li>Create descriptor set for all device buffers. Vulkan descriptor set defines the <em>stage</em> that GPU reads the data (either in vertex shader, fragment shader, or any stage in the ray tracing pipeline) and the <em>way</em> that GPU reads the data (either as uniform samplers, uniform images, storage buffers, uniform buffers, etc.).</li><li>Bind the data buffer with the corresponding descriptor set.</li><li>Create the graphics pipeline. Graphics pipelines are defined in <code>VkPipeline</code>, which specifies the actual procedures of an entire render pass. It can either be defined as a rasterization pipeline (vertex shader &ndash;> primitive assembly &ndash;> rasterization &ndash;> fragment shader), or a ray tracing pipeline (ray generation shader &ndash;> ray intersection shader &ndash;> ray closest hit shader/ray miss shader &ndash;> post processing fragment shader).</li><li>Get the current command buffer, prepare the frame, and run the pre-defined pipeline with all device buffers passing in using descriptor sets.</li></ol><p>Vulkan does not render objects directly. Instead, it uses multiple command queues to queue all commands to be passed onto device. This is actually very similar to CUDA as CUDA also uses multiple streams to send commands to the GPU. That&rsquo;s why the graphics command queue comes in.</p><p>The ray tracing pipeline in Vulkan requires the usage of <em>Vulkan Acceleration structures</em>. The acceleration structure is divided into two levels to allow shared usage of geometry resources. For example, if you have a high poly model of sphere mesh formed with 30000 triangles, a great optimisation on the memory side would be to create the acceleration structure only once and transform it two detect intersection of rays with it.</p><p>The structure is stored in form of AABBs and can be controlled by</p><ol><li>Bottom Level Acceleration Structure (BLAS) — Used for creating the the Axis Aligned bounding box for a geometry. Vulkan Provides built in feature to build the AABBs for the triangle primitives but we have to specify the AABBs ourselves for non primitive geometry such as Sphere in our case.</li><li>Top Level Acceleration structure — Points to an instance of BLAS, this allows easy transformations of an exisiting instance of BLAS across the scene.
Note - BLAS requires the AABBs to be passed as 4 bit floating point. So if you see any un intended behaviour do look at memory padding in C++.</li></ol><p>It is generally very hard to set up a complete Vulkan rendering pipeline from the lowest-level Vulkan libraries. Nowadays, there have been many different styles of Vulkan libraries wrappers for cleaner code production. In this project we took the advantage of <a href=https://github.com/nvpro-samples/nvpro_core>nvpro</a> to set up a clean Vulkan pipeline for us.</p><h3 id=references>References</h3><ol><li>Daqi Lin, Chris Wyman, Cem Yuksel. <a href=https://research.nvidia.com/publication/2021-11_Fast-Volume-Rendering>Fast Volume Rendering with Spatiotemporal Reservoir Resampling</a>. ACM Transactions on Graphics (Proceedings of SIGGRAPH Asia 2021), 40, 6, 2021.</li><li>Benedikt Bitterli, Chris Wyman, Matt Pharr, Peter Shirley, Aaron Lefohn, and Wojciech Jarosz. 2020. <a href=https://research.nvidia.com/sites/default/files/pubs/2020-07_Spatiotemporal-reservoir-resampling/ReSTIR.pdf>Spatiotemporal reservoir resampling for real-time ray tracing with dynamic direct lighting.</a> <i>ACM Trans. Graph.</i> 39, 4, Article 148 (July 2020), 17 pages. DOI:https://doi.org/10.1145/3386569.3392481</li><li><a href=https://www.omnisci.com/technical-glossary/volume-rendering>Volume Rendering</a></li><li><a href=https://developer.nvidia.com/gpugems/gpugems/part-vi-beyond-triangles/chapter-39-volume-rendering-techniques>Volume Rendering (Nvidia)</a></li><li><a href=https://www.realtimerendering.com/raytracinggems/rtg2/index.html>Ray Tracing Gems II</a></li><li><a href=https://developer.nvidia.com/rtx/raytracing/vkray>Vulkan Ray Tracing Tutorial</a></li><li><a href=https://www.openvdb.org/>OpenVDB</a> for VDB data loading.</li><li><a href=https://github.com/nvpro-samples/nvpro_core>nvpro</a> for Vulkan Ray Tracing KHR setup.</li><li><a href=https://github.com/gabime/spdlog>spdlog</a> for fast C++ logging.</li><li><a href=https://github.com/nvpro-samples/vk_mini_path_tracer>nvpro-samples/vk_mini_path_tracer</a></li><li><a href=https://github.com/nvpro-samples/vk_raytracing_tutorial_KHR>nvpro-samples/vk_raytracing_tutorial_KHR</a></li><li><a href=https://github.com/dipmizu914/ReSTIR_on_Vulkan>dipmizu914/ReSTIR_on_Vulkan</a></li><li>Common graphics utilities <a href=https://github.com/glfw/glfw>glfw</a>, <a href=https://github.com/g-truc/glm>glm</a>, <a href=https://github.com/nothings/stb>stb</a>. These are all included in the <a href=https://github.com/nvpro-samples/nvpro_core>nvpro</a>.</li></ol></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/shineyruan/shineyruan.github.io/edit/main/content/posts/Projects/565-final-project/index.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>Improve this page</a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/posts/projects/467proj-slam/ title="SLAM — Simultaneous Localization And Mapping" class="btn btn-outline-info"><div><i class="fas fa-chevron-circle-left"></i>Prev</div><div class=next-prev-text>SLAM — Simultaneous Localization And Mapping</div></a></div><div class="col-md-6 next-article"><a href=/posts/projects/565-vulkan-grass-rendering/ title="Vulkan Grass Rendering" class="btn btn-outline-info"><div>Next <i class="fas fa-chevron-circle-right"></i></div><div class=next-prev-text>Vulkan Grass Rendering</div></a></div></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#authors>Authors</a></li><li><a href=#demos>Demos</a><ul><li><a href=#rasterization-vs-path-tracing>Rasterization vs. Path Tracing</a></li><li><a href=#restir>ReSTIR</a></li></ul></li><li><a href=#introduction>Introduction</a><ul><li><a href=#vdb-data-structures>VDB Data Structures</a></li><li><a href=#restir-algorithm>ReSTIR Algorithm</a></li><li><a href=#vulkan-ray-tracing>Vulkan Ray Tracing</a></li></ul></li><li><a href=#references>References</a></li></ul></li></ul></nav></div></div></section></div><footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://zhihaoruan.xyz#about>About</a></li><li class=nav-item><a class=smooth-scroll href=https://zhihaoruan.xyz#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=https://zhihaoruan.xyz#experiences>Experiences</a></li><li class=nav-item><a class=smooth-scroll href=https://zhihaoruan.xyz#education>Education</a></li><li class=nav-item><a class=smooth-scroll href=https://zhihaoruan.xyz#projects>Projects</a></li><li class=nav-item><a class=smooth-scroll href=https://zhihaoruan.xyz#recent-posts>Recent Posts</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:shineyruan@gmail.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span><span>shineyruan@gmail.com</span></a></li><li><a href=https://github.com/shineyruan target=_blank rel=noopener><span><i class="fab fa-github"></i></span><span>shineyruan</span></a></li></ul></div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script><script type=text/javascript src=/js/popper.min.js></script><script type=text/javascript src=/js/bootstrap.min.js></script><script type=text/javascript src=/js/navbar.js></script><script type=text/javascript src=/js/plyr.js></script><script type=text/javascript src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script><script src=/js/single.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>