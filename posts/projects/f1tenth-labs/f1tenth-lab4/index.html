<!doctype html><html><head><title>My F1TENTH Journey — Lab 4, Reactive Planning Methods for Obstacle Avoidance</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link rel=stylesheet href=/css/flag-icon.min.css><link rel=stylesheet href=/google-fonts/Mulish/mulish.css><link rel=stylesheet href=/fontawesome/css/all.min.css><link rel=icon type=image/png href=/images/site/favicon-32x32-ZR_hu8be55ec36a526970238b8207e0c8eab8_2764_42x0_resize_box_3.png><meta property="og:title" content="My F1TENTH Journey — Lab 4, Reactive Planning Methods for Obstacle Avoidance"><meta property="og:description" content="F1Tenth Course Lab 4"><meta property="og:type" content="article"><meta property="og:url" content="https://zhihaoruan.xyz/posts/projects/f1tenth-labs/f1tenth-lab4/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-27T23:48:30-04:00"><meta property="article:modified_time" content="2021-01-27T23:48:30-04:00"><meta name=description content="F1Tenth Course Lab 4"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><link rel=stylesheet href=/css/style.css></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/>Ryan's Blog</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><a href=/posts/introduction/ title=Introduction>Introduction</a></li><li><i class="fas fa-plus-circle"></i><a href=/posts/lecturenotes/>Lecture Notes</a><ul><li><a href=/posts/lecturenotes/ve320-notes/ title="VE320 Course Final Summary">VE320 Course Final Summary</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/gallery/>My Personal Gallery</a><ul><li><a href=/posts/gallery/ann-arbor/ title="Ann Arbor">Ann Arbor</a></li><li><a href=/posts/gallery/blue-hour/ title="Blue Hour">Blue Hour</a></li><li><a href=/posts/gallery/covid-19/ title="Capturing COVID-19">Capturing COVID-19</a></li><li><a href=/posts/gallery/hong-kong/ title="Hong Kong">Hong Kong</a></li><li><a href=/posts/gallery/dublin/ title=Ireland>Ireland</a></li><li><a href=/posts/gallery/london/ title=London>London</a></li><li><a href=/posts/gallery/michigan/ title=Michigan>Michigan</a></li><li><a href=/posts/gallery/newcastle/ title=Newcastle>Newcastle</a></li><li><a href=/posts/gallery/zhuhai/ title=Zhuhai>Zhuhai</a></li></ul></li><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/projects/>Projects</a><ul class=active><li><a href=/posts/projects/cad2cav/ title=CAD2CAV>CAD2CAV</a></li><li><a href=/posts/projects/565-cuda-path-tracer/ title="CUDA Path Tracer">CUDA Path Tracer</a></li><li><a href=/posts/projects/373proj/ title="EECS 373 Project">EECS 373 Project</a></li><li><a href=/posts/projects/560proj/ title="Mini Minecraft">Mini Minecraft</a></li><li><a href=/posts/projects/450proj/ title="SJTU Undergraduate Design Expo">SJTU Undergraduate Design Expo</a></li><li><a href=/posts/projects/467proj-slam/ title="SLAM Project">SLAM Project</a></li><li><a href=/posts/projects/565-final-project/ title="Volume Rendered ReSTIR">Volume Rendered ReSTIR</a></li><li><a href=/posts/projects/565-vulkan-grass-rendering/ title="Vulkan Grass Rendering">Vulkan Grass Rendering</a></li><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/projects/f1tenth-labs/>F1Tenth Course Labs</a><ul class=active><li><a href=/posts/projects/f1tenth-labs/f1tenth-lab1/ title="F1Tenth Course Lab 1">F1Tenth Course Lab 1</a></li><li><a href=/posts/projects/f1tenth-labs/f1tenth-lab2/ title="F1Tenth Course Lab 2">F1Tenth Course Lab 2</a></li><li><a href=/posts/projects/f1tenth-labs/f1tenth-lab3/ title="F1Tenth Course Lab 3">F1Tenth Course Lab 3</a></li><li><a class=active href=/posts/projects/f1tenth-labs/f1tenth-lab4/ title="F1Tenth Course Lab 4">F1Tenth Course Lab 4</a></li><li><a href=/posts/projects/f1tenth-labs/f1tenth-lab6/ title="F1Tenth Course Lab 6">F1Tenth Course Lab 6</a></li></ul></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/images/posts/f1tenth-lab4/f1tenth-lab4.png)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/avatar_hufae261693e8da39e936529a400eb43d8_104998_120x120_fit_q75_box.jpg alt="Author Image"><h5 class=author-name>Zhihao (Ryan) Ruan</h5><p>Wednesday, January 27, 2021</p></div><div class=title><h1>My F1TENTH Journey — Lab 4, Reactive Planning Methods for Obstacle Avoidance</h1></div><div class=post-content id=post-content><p><em><strong>This series of blogs marks the journey of my F1/10 Autonomous Racing Cars.</strong></em></p><p><em><strong>All my source codes can be accessed <a href=https://github.com/shineyruan/F1Tenth_Labs>here</a>.</strong></em></p><p><strong>Previous post:</strong></p><ul><li><a href=https://zhihaoruan.xyz/posts/projects/f1tenth-labs/f1tenth-lab1/>My F1TENTH Journey — Lab 1, Introduction to ROS</a></li><li><a href=https://zhihaoruan.xyz/posts/projects/f1tenth-labs/f1tenth-lab2/>My F1TENTH Journey — Lab 2, Automatic Emergency Braking</a></li><li><a href=https://zhihaoruan.xyz/posts/projects/f1tenth-labs/f1tenth-lab3/>My F1TENTH Journey — Lab 3, PID-Controlled Wall Follower</a></li></ul><h2 id=overview>Overview</h2><p>Obstacle avoidance is one of the critical parts of autonomous driving. Crashing into obstacles could possibly bring serious damages to both the car and the object that it runs into. Overtime, researchers and developers have come up with multiple ways to avoid obstacles. This lab focuses on implementing a reactive way (also passive way) of avoiding obstacles to drive the car around in free space, provided with only real-time 2D LiDAR sensor data.</p><h3 id=follow-the-gap-algorithm>&ldquo;Follow the Gap&rdquo; Algorithm</h3><p>With 2D laser scan data, we can easily tell whether there is an obstacle in front of us by looking into the range (length) of each beam. If the range of a certain beam is small, we know that the laser travelling in this direction hits an obstacle in close range; conversely, if the range of a beam is large, we know that the laser beam is able to travel very far before hitting on an obstacle, and thus we can consider this direction as &ldquo;free space&rdquo;. &ldquo;Follow the Gap&rdquo; algorithm states that, for each incoming <code>LaserScan</code> LiDAR data, we first figure out the direction of the closest obstacle, and then try to maneuver the vehicle in the direction of &ldquo;free space&rdquo; to avoid this obstacle.</p><p>In theory, &ldquo;Follow the Gap&rdquo; planner can be done in the several steps:</p><ol><li>Find the nearest LiDAR endpoint and put a &ldquo;safety bubble&rdquo; of radius $r$ around it.</li><li>Set all endpoints inside the bubble to distance $0$. All non-zero endpoints are considered &ldquo;free space&rdquo;.</li><li>Find maximum length sequence of consecutive non-zero endpoints and identify the &ldquo;widest&rdquo; free space. (The <strong>max-gap.</strong>)</li><li>Choose the furthest endpoint in the max-gap, and steer the vehicle in that direction with some certain speed.</li></ol><figure><img src=f1tenth-lab4.png alt="&amp;lsquo;Follow the Gap&amp;rsquo; Algorithms in diagrams."><figcaption><p>&lsquo;Follow the Gap&rsquo; Algorithms in diagrams.</p></figcaption></figure><h3 id=notes-in-real-practice>Notes in Real Practice</h3><ol><li><strong>Laser scan data must be smoothed and de-noised.</strong></li></ol><p>In actual implementation, we can never obtain a clean laser scan data from LiDAR sensor. Due to hardware issues the raw data would contain lots of noises and glitches. To smooth the data, I applied a <strong>sliding window of size 5</strong> to average out each of the endpoints. I also <strong>clip the data within <code>[range_min, range_max)</code></strong> according to the parameters in the incoming <code>LaserScan</code> ROS message.</p><ol start=2><li><strong>Calculate the distance between two laser scan endpoints with trigonometric formulas.</strong></li></ol><p>In the algorithm we wish to draw a &ldquo;safety bubble&rdquo; around the nearest endpoint by traversing all laser beams and setting all endpoints within the radius of that bubble to $0$. But with laser scan data, how can we compute the distance between two endpoints? Trigonometry provides us with a power tool called <a href=https://en.wikipedia.org/wiki/Law_of_cosines><strong>the Law of Cosines.</strong></a> With laser beams of range $r_1,r_2$ and their angle $\theta$, we can draw a triangle among the vehicle, endpoint 1, endpoint 2, and apply:
$$d=\sqrt{r_1^2+r_2^2-2r_1r_2\cos\theta},$$
which gives us the distance between the two endpoints.</p><ol start=3><li><strong>Impose a &ldquo;safety angle&rdquo; around the safety bubbles.</strong></li></ol><p>One of the corner case in testing the algorithm is the corner of the wall. As the figure indicates below, the car detects the corner of the wall and has marked it as an obstacle, setting all points within the safety bubble as 0. However, <em>the laser beam direction that detects the farthest endpoint in the max-gap happens to be right next to the obstacle,</em> causing the car to make a left turn rather than right turn, and directly hits the wall.</p><figure><img src=f1tenth-lab4-safety-angle.png alt="Demonstration of a corner case without safety angle." width=400><figcaption><p>Demonstration of a corner case without safety angle.</p></figcaption></figure><p>To address this issue, I added a &ldquo;safety angle&rdquo; around the bubble, which basically sets the laser beams too close to the direction of obstacles to distance 0. For instance, a safety angle of 20 degrees would set additional laser beams in the direction leftwards of the bubble by 20 degrees and rightwards of that bubble by 20 degrees also to 0. This simple method would prevent the vehicle to get too close to the obstacle, even if the best direction of free space happens to be next to the obstacle.</p><h2 id=demo-videos>Demo Videos</h2><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/tDPHbiQ0Ds8 style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div><h2 id=references>References</h2><p>F1/10 Autonomous Racing Lecture: Reactive Methods for Planning<div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/7VLYP-z9hTw style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div></p></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/shineyruan/shineyruan.github.io/edit/main/content/posts/Projects/f1tenth-labs/f1tenth-lab4/index.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Improve this page</a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/posts/projects/f1tenth-labs/f1tenth-lab3/ title="My F1TENTH Journey — Lab 3, PID-Controlled Wall Follower" class="btn btn-outline-info"><div><i class="fas fa-chevron-circle-left"></i> Prev</div><div class=next-prev-text>My F1TENTH Journey — Lab 3, PID-Controlled Wall Follower</div></a></div><div class="col-md-6 next-article"><a href=/posts/projects/f1tenth-labs/f1tenth-lab6/ title="My F1TENTH Journey — Lab 6, Pure Pursuit (Waypoint Tracker)" class="btn btn-outline-info"><div>Next <i class="fas fa-chevron-circle-right"></i></div><div class=next-prev-text>My F1TENTH Journey — Lab 6, Pure Pursuit (Waypoint Tracker)</div></a></div></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#overview>Overview</a><ul><li><a href=#follow-the-gap-algorithm>&ldquo;Follow the Gap&rdquo; Algorithm</a></li><li><a href=#notes-in-real-practice>Notes in Real Practice</a></li></ul></li><li><a href=#demo-videos>Demo Videos</a></li><li><a href=#references>References</a></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://zhihaoruan.xyz#about>About</a></li><li class=nav-item><a class=smooth-scroll href=https://zhihaoruan.xyz#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=https://zhihaoruan.xyz#experiences>Experiences</a></li><li class=nav-item><a class=smooth-scroll href=https://zhihaoruan.xyz#education>Education</a></li><li class=nav-item><a class=smooth-scroll href=https://zhihaoruan.xyz#projects>Projects</a></li><li class=nav-item><a class=smooth-scroll href=https://zhihaoruan.xyz#recent-posts>Recent Posts</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:shineyruan@gmail.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>shineyruan@gmail.com</span></a></li><li><a href=https://github.com/shineyruan target=_blank rel=noopener><span><i class="fab fa-github"></i></span> <span>shineyruan</span></a></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2018 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script>
<script type=text/javascript src=/js/popper.min.js></script>
<script type=text/javascript src=/js/bootstrap.min.js></script>
<script type=text/javascript src=/js/navbar.js></script>
<script type=text/javascript src=/js/plyr.js></script>
<script type=text/javascript src=/js/main.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script>
<script src=/js/single.js></script>
<script>hljs.initHighlightingOnLoad()</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script></body></html>