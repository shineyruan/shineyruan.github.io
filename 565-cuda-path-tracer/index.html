<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>CUDA Path Tracer with À-Trous Denoiser - Ryan's Blog</title><meta name=Description content="Yet another documentation of life."><meta property="og:title" content="CUDA Path Tracer with À-Trous Denoiser"><meta property="og:description" content="Tested on: Ubuntu 20.04 LTS, Ryzen 3700X @ 2.22GHz 48GB, RTX 2060 Super @ 7976MB CUDA Path Tracer Highlights Finished path tracing core features:
diffuse shaders perfect specular reflection 1st-bounce ray intersection caching radix sort by material type path continuation/termination by Thrust stream compaction Finished Advanced Features:
Refraction with Fresnel effects using Schlick&rsquo;s approximation Stochastic sampled anti-aliasing Physically-based depth of field OBJ mesh loading with tinyobjloader Background: Ray Tracing Ray tracing is a technique commonly used in rendering."><meta property="og:type" content="article"><meta property="og:url" content="https://zhihaoruan.xyz/565-cuda-path-tracer/"><meta property="og:image" content="https://zhihaoruan.xyz/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-27T00:43:29+00:00"><meta property="article:modified_time" content="2023-04-01T16:52:00-07:00"><meta property="og:site_name" content="Ryan's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://zhihaoruan.xyz/logo.png"><meta name=twitter:title content="CUDA Path Tracer with À-Trous Denoiser"><meta name=twitter:description content="Tested on: Ubuntu 20.04 LTS, Ryzen 3700X @ 2.22GHz 48GB, RTX 2060 Super @ 7976MB CUDA Path Tracer Highlights Finished path tracing core features:
diffuse shaders perfect specular reflection 1st-bounce ray intersection caching radix sort by material type path continuation/termination by Thrust stream compaction Finished Advanced Features:
Refraction with Fresnel effects using Schlick&rsquo;s approximation Stochastic sampled anti-aliasing Physically-based depth of field OBJ mesh loading with tinyobjloader Background: Ray Tracing Ray tracing is a technique commonly used in rendering."><meta name=application-name content="Ryan's Blog"><meta name=apple-mobile-web-app-title content="Ryan's Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://zhihaoruan.xyz/565-cuda-path-tracer/><link rel=prev href=https://zhihaoruan.xyz/london/><link rel=next href=https://zhihaoruan.xyz/565-vulkan-grass-rendering/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"CUDA Path Tracer with À-Trous Denoiser","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/zhihaoruan.xyz\/565-cuda-path-tracer\/"},"genre":"posts","keywords":"CUDA, computer graphics, ray tracing, Multi-lingual","wordcount":1463,"url":"https:\/\/zhihaoruan.xyz\/565-cuda-path-tracer\/","datePublished":"2021-12-27T00:43:29+00:00","dateModified":"2023-04-01T16:52:00-07:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Zhihao Ruan"},"description":""}</script></head><body data-header-desktop=auto data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Ryan's Blog">Ryan's Blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/categories/projects/>Projects </a><a class=menu-item href=/categories/my-gallery/>My Gallery </a><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="menu-item language" title="Select Language"><i class="fa fa-globe" aria-hidden=true></i>
<select class=language-select id=language-select-desktop onchange="location=this.value"><option value=/565-cuda-path-tracer/ selected>English</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Ryan's Blog">Ryan's Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/categories/projects/ title>Projects</a><a class=menu-item href=/categories/my-gallery/ title>My Gallery</a><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class=menu-item title="Select Language"><i class="fa fa-globe fa-fw" aria-hidden=true></i>
<select class=language-select onchange="location=this.value"><option value=/565-cuda-path-tracer/ selected>English</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">CUDA Path Tracer with À-Trous Denoiser</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Zhihao Ruan</a></span>&nbsp;<span class=post-category>included in <a href=/categories/projects/><i class="far fa-folder fa-fw" aria-hidden=true></i>Projects</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2021-12-27>2021-12-27</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1463 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;7 minutes&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/images/posts/565-cuda-path-tracer/cornell.2021-10-09_18-44-15z.5000samp.png data-srcset="/images/posts/565-cuda-path-tracer/cornell.2021-10-09_18-44-15z.5000samp.png, /images/posts/565-cuda-path-tracer/cornell.2021-10-09_18-44-15z.5000samp.png 1.5x, /images/posts/565-cuda-path-tracer/cornell.2021-10-09_18-44-15z.5000samp.png 2x" data-sizes=auto alt=/images/posts/565-cuda-path-tracer/cornell.2021-10-09_18-44-15z.5000samp.png title=/images/posts/565-cuda-path-tracer/cornell.2021-10-09_18-44-15z.5000samp.png width=2560 height=1440></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#cuda-path-tracer>CUDA Path Tracer</a><ul><li><a href=#highlights>Highlights</a></li><li><a href=#background-ray-tracing>Background: Ray Tracing</a><ul><li><a href=#bsdf-bidirectional-scattering-distribution-functions>BSDF: Bidirectional Scattering Distribution Functions</a></li><li><a href=#cuda-optimization-for-ray-tracing>CUDA Optimization for Ray Tracing</a></li></ul></li><li><a href=#results-and-demos>Results and Demos</a><ul><li><a href=#ray-refraction-for-glass-like-materials>Ray Refraction for Glass-like Materials</a></li><li><a href=#stochastic-sampled-anti-aliasing>Stochastic Sampled Anti-Aliasing</a></li><li><a href=#physically-based-depth-of-field>Physically-Based Depth of Field</a></li><li><a href=#mesh-loading>Mesh Loading</a></li></ul></li><li><a href=#performance-analysis>Performance Analysis</a></li></ul></li><li><a href=#cuda-denoiser>CUDA Denoiser</a><ul><li><a href=#physically-based-ray-traced-pbrt-image-with-à-trous-denoising>Physically-Based Ray Traced (PBRT) Image with À-Trous Denoising</a></li><li><a href=#highlights-1>Highlights</a></li><li><a href=#introduction>Introduction</a></li><li><a href=#qualitative-analysis>Qualitative Analysis</a><ul><li><a href=#visual-results-vs-filter-size>Visual Results vs. Filter Size</a></li><li><a href=#visual-results-vs-material-type>Visual Results vs. Material Type</a></li><li><a href=#visual-results-vs-light-conditions>Visual Results vs. Light Conditions</a></li></ul></li><li><a href=#quantitative-analysis>Quantitative Analysis</a><ul><li><a href=#denoising-time>Denoising Time</a></li><li><a href=#number-of-iterations-needed-for-a-smooth-image>Number of Iterations Needed for a Smooth Image</a></li><li><a href=#denoising-runtime-vs-resolution-filter-size>Denoising Runtime vs. Resolution, Filter Size</a></li></ul></li></ul></li><li><a href=#references>References</a></li></ul></nav></div></div><div class=content id=content><ul><li>Tested on: Ubuntu 20.04 LTS, Ryzen 3700X @ 2.22GHz 48GB, RTX 2060 Super @ 7976MB</li></ul><h2 id=cuda-path-tracer>CUDA Path Tracer</h2><figure><img src=cornell.2021-10-09_18-44-15z.5000samp.png></figure><h3 id=highlights>Highlights</h3><p>Finished path tracing core features:</p><ul><li>diffuse shaders</li><li>perfect specular reflection</li><li>1st-bounce ray intersection caching</li><li>radix sort by material type</li><li>path continuation/termination by Thrust stream compaction</li></ul><p>Finished Advanced Features:</p><ul><li>Refraction with Fresnel effects using Schlick&rsquo;s approximation</li><li>Stochastic sampled anti-aliasing</li><li>Physically-based depth of field</li><li>OBJ mesh loading with <a href=https://github.com/tinyobjloader/tinyobjloader target=_blank rel="noopener noreffer">tinyobjloader</a></li></ul><h3 id=background-ray-tracing>Background: Ray Tracing</h3><p>Ray tracing is a technique commonly used in rendering. Essentially it mimics the actual physical behavior of light: shoots a ray from every pixel in an image and calculates the final color of the ray by bouncing it off on every surface it hits in the world, until it reaches the light source. In practice a maximum number of depth (bouncing times) would be specified, so that we would not have to deal with infinitely bouncing rays.</p><p>Ray tracing is one of the applications considered as &ldquo;embarrassingly parallel&rdquo;, given the fact that each ray is completely independent of other rays. Hence, it is best to run on an GPU which is capable of providing hundreds of thousands of threads for parallel algorithms. This project aims at developing a CUDA-based application for customized ray tracing.</p><h4 id=bsdf-bidirectional-scattering-distribution-functions>BSDF: Bidirectional Scattering Distribution Functions</h4><p>BSDF is a collection of models that approximates the light behavior in real world. It is commonly known to consist of BRDF (Reflection) models and BTDF (Transmission) models. Some typical reflection models include:</p><ul><li><em>Ideal specular</em> (perfect mirror, <code>glm::reflect</code>)</li><li><em>Ideal diffuse.</em> It is a model that the direction of the reflected ray is randomly sampled from the incident hemisphere, along with other advanced sampling methods.</li><li><em>Microfacet,</em> such as <a href=https://media.disneyanimation.com/uploads/production/publication_asset/48/asset/s2012_pbs_disney_brdf_notes_v3.pdf target=_blank rel="noopener noreffer">Disney model</a>.</li><li><em>Glossy specular.</em></li><li><em>Subsurface scattering.</em></li><li>&mldr;</li></ul><p>Some typical transmission models include:</p><ul><li><em>Fresnel effect refraction.</em> It consists of a regular transmission model based on <a href=https://en.wikipedia.org/wiki/Snell%27s_law target=_blank rel="noopener noreffer">Snell&rsquo;s law</a> and a partially reflective model based on <a href=https://en.wikipedia.org/wiki/Fresnel_equations target=_blank rel="noopener noreffer">Fresnel effect</a> and its <a href=https://en.wikipedia.org/wiki/Schlick%27s_approximation target=_blank rel="noopener noreffer">Schlick&rsquo;s approximations</a>.</li><li>&mldr;</li></ul><h4 id=cuda-optimization-for-ray-tracing>CUDA Optimization for Ray Tracing</h4><p>In order to better utilize CUDA hardware for ray tracing, it is not suggested to parallelize each pixel, as it would lead to a huge amount of divergence.</p><figure><img src=ray-tracing-divergence.png></figure><p>Instead, one typical optimization people use is to parallelize each <em>ray</em>, and uses <strong>stream compaction</strong> to remove those rays that terminates early. By this means we could better recycle the early ending warps for ray tracing other pixels.</p><figure><img src=ray-tracing-parallel-rays.png></figure><h3 id=results-and-demos>Results and Demos</h3><h4 id=ray-refraction-for-glass-like-materials>Ray Refraction for Glass-like Materials</h4><table><thead><tr><th style=text-align:center>Perfect Specular Reflection</th><th style=text-align:center>Glass-like Refraction</th></tr></thead><tbody><tr><td style=text-align:center><figure><img src=cornell.2021-10-04_02-10-06z.5000samp.png></figure></td><td style=text-align:center><figure><img src=cornell.2021-10-04_01-57-31z.5000samp.png></figure></td></tr></tbody></table><h4 id=stochastic-sampled-anti-aliasing>Stochastic Sampled Anti-Aliasing</h4><table><thead><tr><th style=text-align:center>1x Anti-Aliasing (Feature OFF)</th><th style=text-align:center>4x Anti-Aliasing</th></tr></thead><tbody><tr><td style=text-align:center><figure><img src=cornell.2021-10-04_01-14-01z.5000samp-antialias-1x.png></figure></td><td style=text-align:center><figure><img src=cornell.2021-10-04_01-07-24z.5000samp-antialias-4x.png></figure></td></tr></tbody></table><h4 id=physically-based-depth-of-field>Physically-Based Depth of Field</h4><table><thead><tr><th style=text-align:center>Pinhole Camera Model (Feature OFF)</th><th style=text-align:center>Thin-Lens Camera Model</th></tr></thead><tbody><tr><td style=text-align:center><figure><img src=cornell.2021-10-05_02-45-59z.5000samp.png></figure></td><td style=text-align:center><figure><img src=cornell.2021-10-05_02-40-08z.5000samp.png></figure></td></tr></tbody></table><h4 id=mesh-loading>Mesh Loading</h4><p>Mesh loading has not been fully supported due to an incorrect normal vector parsing issue in <a href=https://github.com/tinyobjloader/tinyobjloader target=_blank rel="noopener noreffer">tinyobjloader</a>. The runtime is also unoptimized and takes an unreasonable amount of time to run.</p><p>TODO:</p><ul><li>Bounding volume culling with AABB box/OBB box.</li></ul><h3 id=performance-analysis>Performance Analysis</h3><p>Throughout the project two optimizations were done:</p><ol><li><strong>Cache ray first bounce.</strong> For every iteration in a rendering process, the first rays that shoot from camera to the first hit surface is always the same. Therefore we can cache the first shooting ray during the first iteration and reuse the results in all the following iterations.</li><li><strong>Radix-sort hit attributes by material type.</strong> The calculation of resulting colors for each ray depends on the material of the object it hits, and thus we can sort the rays based on material type before shading to enforce CUDA memory coalescence.</li></ol><figure><img src=sort-material-type.png></figure><p>The following experiments are conducted on a Cornell box scene as shown in <a href=scenes/cornell_profiling.txt rel><code>cornell_profiling.txt</code></a> with varying iterations from 300 to 2000.</p><figure><img src=performance-analysis.png></figure><p>From the performance analysis we can see that caching the first bounce for the 1st iteration has a slight improvement on the performance, while radix-sorting the material type before shading have a great negative impact on the performance. This is possibly due to the reason that radix-sorting itself takes a lot amount of time in each iteration.</p><h2 id=cuda-denoiser>CUDA Denoiser</h2><h3 id=physically-based-ray-traced-pbrt-image-with-à-trous-denoising>Physically-Based Ray Traced (PBRT) Image with À-Trous Denoising</h3><table><thead><tr><th style=text-align:center>PBRT, 5000 iterations</th><th style=text-align:center>PBRT, 5000 iterations, 4x anti-aliasing</th></tr></thead><tbody><tr><td style=text-align:center><figure><img src=cornell.2021-10-21_22-45-59z.5000samp.original.png></figure></td><td style=text-align:center><figure><img src=cornell.2021-10-21_22-47-57z.5000samp.original.png></figure></td></tr></tbody></table><table><thead><tr><th style=text-align:center>PBRT, 100 iterations</th><th style=text-align:center>PBRT, 100 iterations, À-Trous Denoising</th></tr></thead><tbody><tr><td style=text-align:center><figure><img src=cornell.2021-10-21_21-56-47z.100samp.original.png></figure></td><td style=text-align:center><figure><img src=cornell.2021-10-21_22-57-08z.100samp.denoised.png></figure></td></tr></tbody></table><h3 id=highlights-1>Highlights</h3><p>Implemented <a href=https://jo.dreggn.org/home/2010_atrous.pdf target=_blank rel="noopener noreffer">Edge-Avoiding À-Trous Wavelet Transform</a> denoising techniques with 5x5 Gaussian blur kernel.</p><h3 id=introduction>Introduction</h3><p>Physically-Based Ray Tracing (PBRT) is considered as one of the best methods that produce the most photorealistic images. The essence of PBRT is to approximate <a href=https://en.wikipedia.org/wiki/Rendering_equation target=_blank rel="noopener noreffer">the rendering equation</a> with Monte-Carlo integration, sampling multiple rays from each pixel of an image and bouncing them off multiple times from various surfaces of different kinds and different textures according to the ray directions, accumulating the colors along the way.</p><p>However, in reality it is very hard to run PBRT in real time, as we often need a large amount of rays to obtain a reasonable good approximation for the rendering equation. Hence, people come up with multiple ways of applying denoising techniques on partially ray-traced images, hoping that with denoising we could get reasonably good photorealistic images while terminating PBRT early. In this project, we explored <a href=https://jo.dreggn.org/home/2010_atrous.pdf target=_blank rel="noopener noreffer">Edge-Avoiding À-Trous Wavelet Transform</a> for image denoising. For more details, please checkout <a href=INSTRUCTION.md rel>the project instruction</a>.</p><p>The word &ldquo;À-Trous&rdquo; with meaning &ldquo;with holes&rdquo; comes from <a href=https://en.wikipedia.org/wiki/Stationary_wavelet_transform target=_blank rel="noopener noreffer"><em>Algorithme À-Trous</em></a>, which is a stationary wavelet transform commonly used in computer graphics to approximate the effect of a Gaussian filter with much faster performance. It starts from a fix-sized Gaussian filter, performs convolution on the image while expanding out each element of the filter at every iteration, filling all missing entries with 0s. The &ldquo;Edge-Avoiding&rdquo; part of the algorithm incorporates the use of a pixel-wise <em>GBuffer</em>, storing positions and normals of the first hit for each ray. When the image is denoised, information of the GBuffer will be used to avoid blurring edges in the image, while the noisy surfaces are smoothed.</p><figure><img src=a-trous.png></figure><table><thead><tr><th style=text-align:center>Pure À-Trous Filtering</th><th style=text-align:center>À-Trous Filtering with Edge-Avoiding GBuffer</th></tr></thead><tbody><tr><td style=text-align:center><figure><img src=cornell.2021-10-22_00-46-51z.100samp.denoised.png></figure></td><td style=text-align:center><figure><img src=cornell.2021-10-22_00-47-47z.100samp.denoised.png></figure></td></tr></tbody></table><h3 id=qualitative-analysis>Qualitative Analysis</h3><h4 id=visual-results-vs-filter-size>Visual Results vs. Filter Size</h4><p>The following experiments are run with <code>c_phi=132.353, n_phi=0.245, p_phi=1.324</code>.</p><table><thead><tr><th style=text-align:center>Filter Size = 6</th><th style=text-align:center>Filter Size = 15</th><th style=text-align:center>Filter Size = 32</th><th style=text-align:center>Filter Size = 100</th></tr></thead><tbody><tr><td style=text-align:center><figure><img src=denoise.filtersize.6.png></figure></td><td style=text-align:center><figure><img src=denoise.filtersize.15.png></figure></td><td style=text-align:center><figure><img src=denoise.filtersize.32.png></figure></td><td style=text-align:center><figure><img src=denoise.filtersize.100.png></figure></td></tr></tbody></table><p>From the results we can see that the visual results does not vary uniformly with the filter size. When the filter reaches some size threshold, it is no longer the filter size that stops the smoothing process but the weights of the GBuffer instead.</p><h4 id=visual-results-vs-material-type>Visual Results vs. Material Type</h4><p>The following experiments are run with <code>c_phi=132.353, n_phi=0.245, p_phi=1.324, filter_size=100</code>.</p><table><thead><tr><th style=text-align:center>Diffuse</th><th style=text-align:center>Reflective</th><th style=text-align:center>Refractive</th></tr></thead><tbody><tr><td style=text-align:center><figure><img src=denoise-diffuse.png></figure></td><td style=text-align:center><figure><img src=denoise-specular.png></figure></td><td style=text-align:center><figure><img src=denoise-refraction.png></figure></td></tr></tbody></table><p>From the results we can see that the filter works best with diffuse materials, reasonably well with refractive materials, and the worst with reflective materials. This is mainly because the current implementation only caches the position & normal vectors of the first hit, while this property does not really apply to reflective materials (colors on a pure-reflective material depend heavily on the material properties from the 2nd hit). As a result, the filter is blurring the reflection on the reflective materials.</p><h4 id=visual-results-vs-light-conditions>Visual Results vs. Light Conditions</h4><p>The following experiments are run with <code>c_phi=132.353, n_phi=0.245, p_phi=1.324, filter_size=100</code>.</p><table><thead><tr><th style=text-align:center>Cornell Box</th><th style=text-align:center>Cornell Box with Large Lights</th></tr></thead><tbody><tr><td style=text-align:center><figure><img src=denoise-cornell.png></figure></td><td style=text-align:center><figure><img src=denoise-cornell-ceiling-light.png></figure></td></tr></tbody></table><p>From the results we can see that the filter works better in brighter lighting conditions. This is because in brighter lighting conditions the color tends to be more similar locally, while with point lights the color differs much from its adjacent pixels, making it more difficult to smooth.</p><h3 id=quantitative-analysis>Quantitative Analysis</h3><h4 id=denoising-time>Denoising Time</h4><p>For a standard scene as shown in <a href=#physically-based-ray-traced-pbrt-image-with-%c3%a0-trous-denoising rel>Physically-Based Ray Traced (PBRT) Image with À-Trous Denoising</a>, the denoising time for a 800x800 image with <code>c_phi=132.353, n_phi=0.245, p_phi=1.324, filter_size=100</code> is:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>----- Begin image denoising -----
</span></span><span class=line><span class=cl>   elapsed time: 31.2983ms    <span class=o>(</span>CUDA Measured<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>which is a reasonably fast denoising time.</p><h4 id=number-of-iterations-needed-for-a-smooth-image>Number of Iterations Needed for a Smooth Image</h4><p>The following experiments are run with <code>c_phi=132.353, n_phi=0.245, p_phi=1.324, filter_size=100</code>.</p><table><thead><tr><th style=text-align:center>Iteration = 1</th><th style=text-align:center>Iteration = 10</th><th style=text-align:center>Iteration = 25</th></tr></thead><tbody><tr><td style=text-align:center><figure><img src=denoise-iter-1.png></figure></td><td style=text-align:center><figure><img src=denoise-iter-10.png></figure></td><td style=text-align:center><figure><img src=denoise-iter-25.png></figure></td></tr></tbody></table><table><thead><tr><th style=text-align:center>Iteration = 50</th><th style=text-align:center>Iteration = 100</th></tr></thead><tbody><tr><td style=text-align:center><figure><img src=denoise-iter-50.png></figure></td><td style=text-align:center><figure><img src=denoise-iter-100.png></figure></td></tr></tbody></table><p>From the results we can see that subjectively, with the parameters specified above, we can get a reasonably smooth image with number of iterations at least 50.</p><h4 id=denoising-runtime-vs-resolution-filter-size>Denoising Runtime vs. Resolution, Filter Size</h4><p>The following experiments are run with <code>c_phi=132.353, n_phi=0.245, p_phi=1.324</code>. For varying resolution, <code>filter_size = 100</code>; for varying filter size, <code>resolution = 800x800</code>.</p><table><thead><tr><th style=text-align:center>Runtime vs. Resolution</th><th style=text-align:center>Runtime vs. Filter Size</th></tr></thead><tbody><tr><td style=text-align:center><figure><img src=denoise_runtime_resolution.png></figure></td><td style=text-align:center><figure><img src=denoise_runtime_filter_size.png></figure></td></tr></tbody></table><p>From the results we can see that the runtime increases quadratically with resolution as the number of pixels increases quadratically with resolution; the runtime increases linearly with filter size, as increasing filter size would only increase the number of iterations that À-Trous wavelet transform needs to run.</p><h2 id=references>References</h2><ul><li>[PBRT] Physically Based Rendering, Second Edition: From Theory To Implementation. Pharr, Matt and Humphreys, Greg. 2010.</li><li>Antialiasing and Raytracing. Chris Cooksey and Paul Bourke, <a href=http://paulbourke.net/miscellaneous/aliasing/ target=_blank rel="noopener noreffer">http://paulbourke.net/miscellaneous/aliasing/</a></li><li><a href=http://graphics.ucsd.edu/courses/cse168_s14/ target=_blank rel="noopener noreffer">Sampling notes</a> from Steve Rotenberg and Matteo Mannino, University of California, San Diego, CSE168: Rendering Algorithms</li><li>Path Tracer Readme Samples (non-exhaustive list):<ul><li><a href=https://github.com/byumjin/Project3-CUDA-Path-Tracer target=_blank rel="noopener noreffer">https://github.com/byumjin/Project3-CUDA-Path-Tracer</a></li><li><a href=https://github.com/lukedan/Project3-CUDA-Path-Tracer target=_blank rel="noopener noreffer">https://github.com/lukedan/Project3-CUDA-Path-Tracer</a></li><li><a href=https://github.com/botforge/CUDA-Path-Tracer target=_blank rel="noopener noreffer">https://github.com/botforge/CUDA-Path-Tracer</a></li><li><a href=https://github.com/taylornelms15/Project3-CUDA-Path-Tracer target=_blank rel="noopener noreffer">https://github.com/taylornelms15/Project3-CUDA-Path-Tracer</a></li><li><a href=https://github.com/emily-vo/cuda-pathtrace target=_blank rel="noopener noreffer">https://github.com/emily-vo/cuda-pathtrace</a></li><li><a href=https://github.com/ascn/toki target=_blank rel="noopener noreffer">https://github.com/ascn/toki</a></li><li><a href=https://github.com/gracelgilbert/Project3-CUDA-Path-Tracer target=_blank rel="noopener noreffer">https://github.com/gracelgilbert/Project3-CUDA-Path-Tracer</a></li><li><a href=https://github.com/vasumahesh1/Project3-CUDA-Path-Tracer target=_blank rel="noopener noreffer">https://github.com/vasumahesh1/Project3-CUDA-Path-Tracer</a></li></ul></li><li><a href=https://jo.dreggn.org/home/2010_atrous.pdf target=_blank rel="noopener noreffer">Edge-Avoiding A-Trous Wavelet Transform for fast Global Illumination Filtering</a></li><li><a href=https://research.nvidia.com/publication/2017-07_Spatiotemporal-Variance-Guided-Filtering%3A target=_blank rel="noopener noreffer">Spatiotemporal Variance-Guided Filtering</a></li><li><a href=http://jcgt.org/published/0003/02/01/paper.pdf target=_blank rel="noopener noreffer">A Survey of Efficient Representations for Independent Unit Vectors</a></li><li>ocornut/imgui - <a href=https://github.com/ocornut/imgui target=_blank rel="noopener noreffer">https://github.com/ocornut/imgui</a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-04-01&nbsp;<a class=git-hash href=https://github.com/shineyruan/shineyruan.github.io/commit/881cce5bfc0baf6b0648461fbe67ed6b74796885 target=_blank title="commit by Zhihao Ruan(shineyruan@gmail.com) 881cce5bfc0baf6b0648461fbe67ed6b74796885: remove broken links">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>881cce5</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/565-cuda-path-tracer/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://zhihaoruan.xyz/565-cuda-path-tracer/ data-title="CUDA Path Tracer with À-Trous Denoiser" data-hashtags="CUDA,computer graphics,ray tracing,Multi-lingual"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://zhihaoruan.xyz/565-cuda-path-tracer/ data-hashtag=CUDA><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://zhihaoruan.xyz/565-cuda-path-tracer/ data-title="CUDA Path Tracer with À-Trous Denoiser"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://zhihaoruan.xyz/565-cuda-path-tracer/ data-title="CUDA Path Tracer with À-Trous Denoiser"><i data-svg-src=/lib/simple-icons/icons/line.min.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://zhihaoruan.xyz/565-cuda-path-tracer/ data-title="CUDA Path Tracer with À-Trous Denoiser" data-image=/images/posts/565-cuda-path-tracer/cornell.2021-10-09_18-44-15z.5000samp.png><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/cuda/>CUDA</a>,&nbsp;<a href=/tags/computer-graphics/>computer graphics</a>,&nbsp;<a href=/tags/ray-tracing/>ray tracing</a>,&nbsp;<a href=/tags/multi-lingual/>Multi-lingual</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/london/ class=prev rel=prev title="London, UK"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>London, UK</a>
<a href=/565-vulkan-grass-rendering/ class=next rel=next title="Vulkan Grass Rendering">Vulkan Grass Rendering<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.112.5">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Zhihao Ruan</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>